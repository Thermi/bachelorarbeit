% This file is part of Bachelorarbeit

% Bachelorarbeit is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License version 3 as published by
% the Free Software Foundation.

% Bachelorarbeit is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.

% You should have received a copy of the GNU General Public License
% along with Foobar. If not, see <http://www.gnu.org/licenses/>.

\section{Appendix}
\label{sec:appendix}

\subsection{Featurematrix}
\label{subsec:featurematrix}
Die Daten aus diesen Tabellen wurden unter Nutzung der öffentlich zugänglichen
Dokumente auf den entsprechenden Herstellerwebseiten erstellt.

Wenn bei einem symmetrischen Verschlüsselungsalgorithmus kein Modus angegeben
war, wurde \ac{CBC} angenommen.

Wenn bei einem Authentifizierungsmodus nicht alle unterstützen Permutationen
angegeben waren, wurden alle standardisierten Permutationen als unterstützt 
angenommen.

Wenn ein Feature nicht explizit als unterstützt angegeben wurde, so wurde angenommen
dass es nicht unterstützt wird.

Offenbar ist der ''bintec Secure IPsec Client'' nur ein Rebranding des ''NCP Secure Entry Client'',
wenn man vom \ac{GUI} ausgehen kann. 
Ein weiteres Indiz ist, dass im Installer des ''bintec Secure IPsec Client''
der String ''NCP engineering GmbH'' auftaucht. Daher wäre es zu verstehen,
wenn aus den Dokumentationen der beiden Produkte Featureparität hervorkäme.
Dem ist aber nicht so, wie aus den Tabellen hervorgeht.

Diese Tabellen beziehen sich nur auf die Fähigkeiten, die ab Windows 7 unterstützt sind.
Sie machen keine Aussage über die Unterstützung der Software auf anderen Platformen
und hat keinen Anspruch auf Vollständigkeit.

\paragraph{Symbolik}
\begin{description}
\item[x] Unterstützt
\item[o] Nicht unterstützt
\item[?] unbekannt
\end{description}
\paragraph{Referenzen zur Bibliographie}
\begin{itemize}
\item strongSwan\footcite[][]{_ikev1ciphersuites_2016}\footcite[][]{_ikev2ciphersuites_2016}
\item Windows Agile VPN Client\footcite[][]{_windows7_2016}
\item Shrewsoft VPN Client\footcite[][]{_shrew_2013}
\item NCP Secure Entry Client\footcite[][]{jurgen_honig_datenblatt_2016}
\item bintec Secure IPsec Client\footcite[][]{_bintec_2016-1}
\end{itemize}

\begin{center}
\begin{table}[h]
\begin{tabularx}{\textwidth}{|X|X|}\firsthline
Software & IKE-Versionen \\ \hline
strongSwan & IKEv1, IKEv2\\ \hline
Windows Agile VPN Client & IKEv1+L2TP, IKEv2 \\ \hline
Shrewsoft VPN Client & IKEv1 \\ \hline
NCP Secure Entry Client & IKEv1, IKEv2 \\ \hline
bintec Secure IPsec Client & IKEv1, IKEv2 \\ \hline
\end{tabularx}
\label{tab:IPsec-Implementierungen-IKE-Versionen}
\caption{Unterstützte IKE-Versionen der IPsec-Implementierungen}
\end{table}


\begin{table}[h]
\begin{tabularx}{\textwidth}{|X|X|}\firsthline
Software & Lizenz \\ \hline
strongSwan & MIT/GPLv2\footcite[][]{_contributions_2014} \\ \hline
Windows Agile VPN Client & Proprietär \\ \hline
Shrewsoft VPN Client & Shareware\footcite[][]{_shrew_2007} \\ \hline
NCP Secure Entry Client & Proprietär \\ \hline
bintec Secure IPsec Client & Proprietär \\ \hline
\end{tabularx}
\label{tab:IPsec-Implementierungen-Lizenzen}
\caption{Lizenzen der IPsec-Implementierungen}
\end{table}

\begin{table}[h]
\begin{tabularx}{\textwidth}{|X|c|c|c|c|c|}\firsthline
\backslashbox{Modus}{Software} & strongSwan & Windows & Shrewsoft & NCP & bintec \\ \hline
AES-128-CBC          &  x  & x & x & x & x \\  \hline
AES-192-CBC          &  x  & x & x & x & x \\  \hline
AES-256-CBC          &  x  & x & x & x & x \\  \hline
AES-128-GCM-8        &  x  & o & o & o & o \\  \hline
AES-128-GCM-12       &  x  & o & o & o & o \\  \hline
AES-128-GCM-16       &  x  & o & o & o & o \\  \hline
AES-192-GCM-8        &  x  & o & o & o & o \\  \hline
AES-192-GCM-12       &  x  & o & o & o & o \\  \hline
AES-192-GCM-16       &  x  & o & o & o & o \\  \hline
AES-256-GCM-8        &  x  & o & o & o & o \\  \hline
AES-256-GCM-12       &  x  & o & o & o & o \\  \hline
AES-256-GCM-16       &  x  & o & o & o & o \\  \hline
AES-128-CTR          &  x  & o & o & o & o \\  \hline
AES-192-CTR          &  x  & o & o & o & o \\  \hline
AES-256-CTR          &  x  & o & o & o & o \\  \hline
AES-128-CCM-8        &  x  & o & o & o & o \\  \hline
AES-128-CCM-12       &  x  & o & o & o & o \\  \hline
AES-128-CCM-16       &  x  & o & o & o & o \\  \hline
AES-192-CCM-8        &  x  & o & o & o & o \\  \hline
AES-192-CCM-12       &  x  & o & o & o & o \\  \hline
AES-192-CCM-16       &  x  & o & o & o & o \\  \hline
AES-256-CCM-8        &  x  & o & o & o & o \\  \hline
AES-256-CCM-12       &  x  & o & o & o & o \\  \hline
AES-256-CCM-16       &  x  & o & o & o & o \\  \hline
DES-CBC              &  o  & o & x & o & o \\  \hline
3DES-CBC             &  x  & x & x & x & x \\  \hline
BLOWFISH-128-CBC     &  x  & o & x & x & x \\  \hline
BLOWFISH-192-CBC     &  x  & o & x & x & x \\  \hline
BLOWFISH-256-CBC     &  x  & o & x & x & x \\  \hline
CAMELLIA-128-CBC     &  x  & o & o & o & o \\  \hline
CAMELLIA-192-CBC     &  x  & o & o & o & o \\  \hline
CAMELLIA-256-CBC     &  x  & o & o & o & o \\  \hline
CAMELLIA-128-CCM-8   &  x  & o & o & o & o \\  \hline
CAMELLIA-128-CCM-12  &  x  & o & o & o & o \\  \hline
CAMELLIA-128-CCM-16  &  x  & o & o & o & o \\  \hline
CAMELLIA-192-CCM-8   &  x  & o & o & o & o \\  \hline
CAMELLIA-192-CCM-12  &  x  & o & o & o & o \\  \hline
CAMELLIA-192-CCM-16  &  x  & o & o & o & o \\  \hline
CAMELLIA-256-CCM-8   &  x  & o & o & o & o \\  \hline
CAMELLIA-256-CCM-12  &  x  & o & o & o & o \\  \hline
CAMELLIA-256-CCM-16  &  x  & o & o & o & o \\  \hline
SERPENT-128-CBC      &  x  & o & o & o & o \\  \hline
SERPENT-192-CBC      &  x  & o & o & o & o \\  \hline
SERPENT-256-CBC      &  x  & o & o & o & o \\  \hline
TWOFISH-128-CBC      &  x  & o & o & o & o \\  \hline
TWOFISH-192-CBC      &  x  & o & o & o & o \\  \hline
TWOFISH-256-CBC      &  x  & o & o & o & o \\  \hline
CAST-128-CBC         &  x  & o & x & o & o \\  \hline
chacha20poly1305     &  x  & o & o & o & o \\  \hline
\end{tabularx}
\label{tab:IPsec-Implementierungen-Vertraulichkeit-Algorithmen}
\caption{Unterstützte Algorithmen für Vertraulichkeit der IPsec-Implementierungen}
\end{table}

\begin{table}[h]
\begin{tabularx}{\textwidth}{|X|c|c|c|c|c|}\firsthline
\backslashbox{Modus}{Software} & strongSwan & Windows & Shrewsoft & NCP & bintec \\ \hline
MD5                                                     & x & o & x & x & x \\  \hline
SHA-1                                                   & x & x & x & o & x \\  \hline
SHA-256                                                 & x & x & o & x & x \\  \hline
SHA-384                                                 & x & x & o & x & x \\  \hline
SHA-512                                                 & x & o & o & x & x \\  \hline
SHA-256-96\footnote{SHA-256 mit Truncation auf 96 Bit}  & x & x & o & o & o \\  \hline
AES-XCBC                                                & x & o & o & o & o \\  \hline
AES-128-GMAC                                            & x & o & o & o & o \\  \hline
AES-192-GMAC                                            & x & o & o & o & o \\  \hline
AES-256-GMAC                                            & x & o & o & o & o \\  \hline
\end{tabularx}
\label{tab:IPsec-Implementierungen-Authentizitaet-Algorithmen}
\caption{Unterstützte Algorithmen für Authentizität der IPsec-Implementierungen}
\end{table}

\begin{table}[h]
\begin{tabularx}{\textwidth}{|X|c|c|c|c|c|}\firsthline
\backslashbox{Modus}{Software} & strongSwan & Windows & Shrewsoft & NCP & bintec \\ \hline
MODP-768       & x & o & x & x & x \\  \hline
MODP-1024      & x & x & x & x & x \\  \hline
MODP-1536      & x & o & x & x & x \\  \hline
MODP-2048      & x & o & x & x & x \\  \hline
MODP-3072      & x & o & x & x & x \\  \hline
MODP-4096      & x & o & x & x & x \\  \hline
MODP-6144      & x & o & x & x & x \\  \hline
MODP-8192      & x & o & x & x & x \\  \hline
MODP-1024s160  & x & o & o & o & o \\  \hline
MODP-2048s224  & x & o & o & o & o \\  \hline
MODP-2048s256  & x & o & o & o & o \\  \hline
ECP-192        & x & o & o & x & o \\  \hline
ECP-224        & x & o & o & x & o \\  \hline
ECP-256        & x & o & o & x & o \\  \hline
ECP-384        & x & o & o & x & o \\  \hline
ECP-521        & x & o & o & x & o \\  \hline
ECP-224BP      & x & o & o & o & o \\  \hline
ECP-256BP      & x & o & o & o & o \\  \hline
ECP-384BP      & x & o & o & o & o \\  \hline
ECP-512BP      & x & o & o & o & o \\  \hline
NTRU-112       & x & o & o & o & o \\  \hline
NTRU-128       & x & o & o & o & o \\  \hline
NTRU-192       & x & o & o & o & o \\  \hline
NTRU-256       & x & o & o & o & o \\  \hline
NEWHOPE-128    & x & o & o & o & o \\  \hline
\end{tabularx}
\label{tab:IPsec-Implementierungen-DH-Algorithmen}
\caption{Unterstützte Schlüsselaustauschprotokolle der IPsec-Implementierungen}
\end{table}

\begin{table}[h]
\begin{tabularx}{\textwidth}{|X|c|c|c|c|c|}\firsthline
\backslashbox{Modus}{Software} & strongSwan & Windows & Shrewsoft & NCP & bintec                  \\ \hline
Hybrid\footnote{Client mit XAUTH, Server mittels X.509}  & x & x & x & x & x  \\ \hline
PSK                                                      & x & o & x & x & o  \\ \hline
PSK + XAUTH                                              & x & o & x & x & o  \\ \hline
X.509                                                    & x & x & x & x & x  \\ \hline
EAP-MD5                                                  & x & o & o & x & o  \\ \hline
EAP-PAP                                                  & x & o & o & x & o  \\ \hline
EAP-CHAP                                                 & x & o & o & x & o  \\ \hline
EAP-MSCHAPv2                                             & x & x & o & x & o  \\ \hline
EAP-GTC                                                  & x & o & o & o & o  \\ \hline
EAP-TLS                                                  & x & x & o & x & o  \\ \hline
EAP-TTLS                                                 & x & o & o & o & o  \\ \hline
EAP-AKA                                                  & x & o & o & o & o  \\ \hline
EAP-TNC                                                  & x & o & o & o & o  \\ \hline
TNC-IMC                                                  & x & o & o & o & o  \\ \hline
TNC-IMV                                                  & x & o & o & o & o  \\ \hline
\end{tabularx}
\label{tab:IPsec-Implementierungen-Authentifizierungs-Modi}
\caption{Unterstützte Authentifizierungsmethoden der IPsec-Implementierungen}
\end{table}

\begin{table}[h]
\begin{tabularx}{\textwidth}{|X|c|c|c|c|c|}\firsthline
\backslashbox{Modus}{Software} & strongSwan & Windows & Shrewsoft & NCP & bintec \\ \hline
CRL  & x & x & o & x & x \\ \hline
OCSP & x & ? & o & x & x \\ \hline
\end{tabularx}
\label{tab:IPsec-Implementierungen-CRL-Support}
\caption{Unterstützte Mechanismen zum Zurückziehen von Zertifikaten der IPsec-Implementierungen}
\end{table}


\begin{table}[h]
\begin{tabularx}{\textwidth}{|X|c|c|c|c|c|}\firsthline
\backslashbox{Modus}{Software} & strongSwan & Windows & Shrewsoft & NCP & bintec \\ \hline
Tunnel-Modus     & x & x & x & x & x \\  \hline
Transport-Modus  & x & x & o & o & o \\  \hline
BEET-Modus       & x & o & o & o & o \\  \hline
\end{tabularx}
\label{tab:IPsec-Implementierungen-Tunnel-Modi}
\caption{Unterstützte Tunnel-Modi der IPsec-Implementierungen}
\end{table}

\begin{table}[h]
\begin{tabularx}{\textwidth}{|X|c|c|c|c|c|}\firsthline
\backslashbox{Modus}{Software} & strongSwan & Windows & Shrewsoft & NCP & bintec \\ \hline
Main Mode       & x & x & x & x & ? \\ \hline
Aggressive Mode & x & x & x & x & ? \\ \hline 
Quick Mode      & x & o & x & x & ? \\ \hline
Config Mode     & x & x & x & x & x \\ \hline
\end{tabularx}
\label{tab:IPsec-Implementierungen-IKE-Modi}
\caption{Unterstützte IKE-Modi der IPsec-Implementierungen}
\end{table}

\begin{table}[h]
\begin{tabularx}{\textwidth}{|X|c|c|c|c|c|}\firsthline
\backslashbox{Feature}{Software} & strongSwan & Windows & Shrewsoft & NCP & bintec \\ \hline
NAT-T                 & x & x                     & x & x & x \\ \hline
DPD                   & x & x                     & x & x & x \\ \hline
MOBIKE                & x & x                     & o & o & o \\ \hline
GUI                   & o & x                     & x & x & x \\ \hline
IPsec über TCP        & o & o                     & o & x & x \\ \hline
IPv6                  & x & x                     & x & x & x \\ \hline
Attribut-Zertifikate  & x & ?                     & o & o & ? \\ \hline
PFS                   & x & o                     & x & x & x \\ \hline
IKE-Fragmentierung    & x & ?\footnote{Nur IKEv1} & x & o & o \\ \hline
Komprimierung         & x & o                     & o & x & o \\ \hline
\end{tabularx}
\label{tab:IPsec-Implementierungen-Features}
\caption{Unterstützte Features der IPsec-Implementierungen}
\end{table}
\end{center}

\subsection{Testkonfiguration}
\label{subsec:Testkonfiguration}
\begin{center}
\label{lst:swanctl.conf}
\begin{lstlisting}[caption=Testkonfiguration - swanctl.conf,numbers=none]
connections {
        foo {
            version = 2
            dpd_delay = 10
            dpd_timeout = 60
            fragmentation = yes
            send_cert = always
            remote_addrs = 37.120.161.220
            proposals = aes256gcm16-prfsha256-modp4096
            vips = 0.0.0.0
			mobike = no
			encap = yes
            local {
                auth = eap-tls
                certs = certificate.pem
            }
            remote {
                auth = pubkey
                id = thermi.strangled.net
                cacerts = serverca.pem
            }
            children {
                    bar {
                        dpd_action = restart
                        start_action = none
                        esp_proposals = aes256-sha256-ecp521
                        remote_ts = 172.16.25.2/32
                    }
            }
        }

}
\end{lstlisting}
\end{center}

\begin{center}
\label{lst:strongswan.conf}
\begin{lstlisting}[caption=Testkonfiguration - strongswan.conf,numbers=none]
charon-svc {

	filelog {
		this_log.txt{
			default=3
			flush_line = yes
			ike_name = yes
			append = no
		}
		
	
	}

}
\end{lstlisting}
\end{center}

\begin{center}
\label{lst:libstrongswan-win32.h}
\begin{lstlisting}[caption=Code von win32.h]
/*
 * Copyright (C) 2016 Noel Kuntze
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

#ifndef WIN32_H
#define WIN32_H

#define WIN32_TUN_READ_EVENT_TEMPLATE "WIN32-libipsec-read-device-%d"
#define WIN32_TUN_WRITE_EVENT_TEMPLATE "WIN32-libipsec-write-device-%d"
#define WIN32_TUN_EVENT_LENGTH 80
#define TAP_WIN_COMPONENT_ID "tap0901"

#define ADAPTER_KEY "SYSTEM\\CurrentControlSet\\Control\\Class\\{4D36E972-E325-11CE-BFC1-08002BE10318}"
#define NETWORK_CONNECTIONS_KEY "SYSTEM\\CurrentControlSet\\Control\\Network\\{4D36E972-E325-11CE-BFC1-08002BE10318}"

/*
 * ======================
 * Filesystem prefixes
 * ======================
 */

#define USERMODEDEVICEDIR "\\\\.\\Global\\"
#define SYSDEVICEDIR      "\\Device\\"
#define USERDEVICEDIR     "\\DosDevices\\Global\\"
#define TAP_WIN_SUFFIX    ".tap"

/*
 * TAP IOCTL constants and macros.
 *
 */
#define TAP_WIN_CONTROL_CODE(request,method) \
  CTL_CODE (FILE_DEVICE_UNKNOWN, request, method, FILE_ANY_ACCESS)

/* Present in 8.1 */

#define TAP_WIN_IOCTL_GET_MAC               TAP_WIN_CONTROL_CODE (1, METHOD_BUFFERED)
#define TAP_WIN_IOCTL_GET_VERSION           TAP_WIN_CONTROL_CODE (2, METHOD_BUFFERED)
#define TAP_WIN_IOCTL_GET_MTU               TAP_WIN_CONTROL_CODE (3, METHOD_BUFFERED)
#define TAP_WIN_IOCTL_GET_INFO              TAP_WIN_CONTROL_CODE (4, METHOD_BUFFERED)
#define TAP_WIN_IOCTL_CONFIG_POINT_TO_POINT TAP_WIN_CONTROL_CODE (5, METHOD_BUFFERED)
#define TAP_WIN_IOCTL_SET_MEDIA_STATUS      TAP_WIN_CONTROL_CODE (6, METHOD_BUFFERED)
#define TAP_WIN_IOCTL_CONFIG_DHCP_MASQ      TAP_WIN_CONTROL_CODE (7, METHOD_BUFFERED)
#define TAP_WIN_IOCTL_GET_LOG_LINE          TAP_WIN_CONTROL_CODE (8, METHOD_BUFFERED)
#define TAP_WIN_IOCTL_CONFIG_DHCP_SET_OPT   TAP_WIN_CONTROL_CODE (9, METHOD_BUFFERED)

/* Added in 8.2 */

/* obsoletes TAP_WIN_IOCTL_CONFIG_POINT_TO_POINT */
#define TAP_WIN_IOCTL_CONFIG_TUN            TAP_WIN_CONTROL_CODE (10, METHOD_BUFFERED)
#define TAP_WIN_IOCTL_CONFIG_SET_SRC_CHECK  TAP_WIN_CONTROL_CODE (11, METHOD_BUFFERED)


#endif /* WIN32_H */
\end{lstlisting}
\end{center}

\begin{center}
\label{lst:tap-windows-patch}
\begin{lstlisting}[caption=Patch für TAP-Windows6]
diff --git a/src/adapter.c b/src/adapter.c
index 2883b79..fd575f9 100644
--- a/src/adapter.c
+++ b/src/adapter.c
@@ -222,6 +222,9 @@ tapReadConfiguration(
     Adapter->MediaStateAlwaysConnected = FALSE;
     Adapter->LogicalMediaState = FALSE;
     Adapter->AllowNonAdmin = FALSE;
+    // source check can not be set in the registry yet. This has to be set each
+    // time the adapter is opened.
+    Adapter->m_source_check = TRUE;
     //
     // Open the registry for this adapter to read advanced
     // configuration parameters stored by the INF file.
diff --git a/src/adapter.h b/src/adapter.h
index 2f09d12..70a394d 100644
--- a/src/adapter.h
+++ b/src/adapter.h
@@ -4,6 +4,7 @@
  *
  *  This code was inspired by the CIPE-Win32 driver by Damion K. Wilson.
  * 
+ *  Copyright (C) 2016 Noel Kuntze <noel@familie-kuntze.de>
  *  This source code is Copyright (C) 2002-2014 OpenVPN Technologies, Inc.,
  *  and is released under the GPL version 2 (see below).
  *
@@ -251,6 +252,10 @@ typedef struct _TAP_ADAPTER_CONTEXT
   BOOLEAN m_CalledAdapterFreeResources;
   BOOLEAN m_RegisteredAdapterShutdownHandler;
 
+   // This variable is initialised as TRUE. If it is set to FALSE, the adapter does
+   // not check the source IP field of the ARP requests it receives on the adapter.
+  BOOLEAN m_source_check;
+
 } TAP_ADAPTER_CONTEXT, *PTAP_ADAPTER_CONTEXT;
 
 FORCEINLINE
diff --git a/src/device.c b/src/device.c
index 2b7ba9b..85897b6 100644
--- a/src/device.c
+++ b/src/device.c
@@ -4,6 +4,7 @@
  *
  *  This code was inspired by the CIPE-Win32 driver by Damion K. Wilson.
  *
+ *  Copyright (C) 2016 Noel Kuntze <noel@familie-kuntze.de>
  *  This source code is Copyright (C) 2002-2014 OpenVPN Technologies, Inc.,
  *  and is released under the GPL version 2 (see below).
  *
@@ -692,7 +693,20 @@ Return Value:
             }
         }
         break;
-
+    case TAP_WIN_IOCTL_CONFIG_SET_SRC_CHECK:
+        {
+            if (inBufLength >= sizeof(ULONG))
+            {
+                adapter->m_source_check = (BOOLEAN) ((PULONG) (Irp->AssociatedIrp.SystemBuffer))[0];
+                Irp->IoStatus.Information = 1;
+            }
+            else
+            {
+                NOTE_ERROR();
+                Irp->IoStatus.Status = ntStatus = STATUS_INVALID_PARAMETER;
+            }
+        }
+        break;
     default:
 
         //
diff --git a/src/tap-windows.h b/src/tap-windows.h
index d546a5b..0809c2e 100644
--- a/src/tap-windows.h
+++ b/src/tap-windows.h
@@ -4,6 +4,7 @@
  *
  *  This code was inspired by the CIPE-Win32 driver by Damion K. Wilson.
  *
+ *  Copyright (C) 2016 Noel Kuntze <noel@familie-kuntze.de>
  *  This source code is Copyright (C) 2002-2014 OpenVPN Technologies, Inc.,
  *  and is released under the GPL version 2 (see below).
  *
@@ -49,7 +50,7 @@
 
 /* obsoletes TAP_WIN_IOCTL_CONFIG_POINT_TO_POINT */
 #define TAP_WIN_IOCTL_CONFIG_TUN            TAP_WIN_CONTROL_CODE (10, METHOD_BUFFERED)
-
+#define TAP_WIN_IOCTL_CONFIG_SET_SRC_CHECK  TAP_WIN_CONTROL_CODE (11, METHOD_BUFFERED)
 /*
  * =================
  * Registry keys
diff --git a/src/txpath.c b/src/txpath.c
index f627934..8af5f21 100644
--- a/src/txpath.c
+++ b/src/txpath.c
@@ -4,6 +4,7 @@
  *
  *  This code was inspired by the CIPE-Win32 driver by Damion K. Wilson.
  * 
+ *  Copyright (C) 2016 Noel Kuntze <noel@familie-kuntze.de>
  *  This source code is Copyright (C) 2002-2014 OpenVPN Technologies, Inc.,
  *  and is released under the GPL version 2 (see below).
  *
@@ -216,6 +217,15 @@ ProcessARP(
     //-----------------------------------------------
     // Is this the kind of packet we are looking for?
     //-----------------------------------------------
+    BOOLEAN source_check = FALSE;
+    if (Adapter->m_source_check)
+    {
+        source_check = (src->m_ARP_IP_Source == adapter_ip);
+    }
+    else
+    {
+        source_check = TRUE;
+    }
     if (src->m_Proto == htons (NDIS_ETH_TYPE_ARP)
         && MAC_EQUAL (src->m_MAC_Source, Adapter->PermanentAddress)
         && MAC_EQUAL (src->m_ARP_MAC_Source, Adapter->PermanentAddress)
@@ -225,7 +235,7 @@ ProcessARP(
         && src->m_MAC_AddressSize == sizeof (MACADDR)
         && src->m_PROTO_AddressType == htons (NDIS_ETH_TYPE_IPV4)
         && src->m_PROTO_AddressSize == sizeof (IPADDR)
-        && src->m_ARP_IP_Source == adapter_ip
+        && source_check
         && (src->m_ARP_IP_Destination & ip_netmask) == ip_network
         && src->m_ARP_IP_Destination != adapter_ip)
     {
\end{lstlisting}
\end{center}

\begin{center}
\label{lst:get_tap_req}
\begin{lstlisting}[caption=Code für das Suchen eines TAP-Geräts]
/*
 * Searches through the registry for suitable TAP driver interfaces
 * On Windows, the TAP interface metadata is stored and described in the registry.
 * It returns a linked list that contains all found guids. The guids describe the interfaces.
 */

linked_list_t *get_tap_reg()
{
    HKEY adapter_key;
    LONG status;
    DWORD len;
    linked_list_t *list = linked_list_create();
    int i = 0;

    /*
     * Open parent key. It contains all other keys that
     * describe any possible interfaces.
     */
    status = RegOpenKeyEx(
            HKEY_LOCAL_MACHINE,
            ADAPTER_KEY,
            0,
            KEY_READ,
            &adapter_key);

    if (status != ERROR_SUCCESS)
    {
        DBG2(DBG_LIB, "Error opening registry key: %s", ADAPTER_KEY);
    }

    while (true)
    {
        char enum_name[256];
        char unit_string[256];
        HKEY unit_key;
        char component_id_string[] = "ComponentId";
        char component_id[256];
        char net_cfg_instance_id_string[] = "NetCfgInstanceId";
        char net_cfg_instance_id[256];
        DWORD data_type;

        len = sizeof (enum_name);
        status = RegEnumKeyEx(
                adapter_key,
                i,
                enum_name,
                &len,
                NULL,
                NULL,
                NULL,
                NULL);
        if (status == ERROR_NO_MORE_ITEMS)
        {
            break;
        }
        else if (status != ERROR_SUCCESS)
        {
            DBG2(DBG_LIB, "Error enumerating registry subkeys of key: %s",
                    ADAPTER_KEY);
        }

        snprintf(unit_string, sizeof (unit_string), "%s\\%s",
                ADAPTER_KEY, enum_name);

        status = RegOpenKeyEx(
                HKEY_LOCAL_MACHINE,
                unit_string,
                0,
                KEY_READ,
                &unit_key);

        if (status != ERROR_SUCCESS)
        {
            DBG2(DBG_LIB, "Error opening registry key: %s", unit_string);
        }
        else
        {
            len = sizeof (component_id);
            status = RegQueryValueEx(
                    unit_key,
                    component_id_string,
                    NULL,
                    &data_type,
                    component_id,
                    &len);

            if (status != ERROR_SUCCESS || data_type != REG_SZ)
            {
                DBG2(DBG_LIB, "Error opening registry key: %s\\%s",
                        unit_string, component_id_string);
            }
            else
            {
                len = sizeof (net_cfg_instance_id);
                status = RegQueryValueEx(
                        unit_key,
                        net_cfg_instance_id_string,
                        NULL,
                        &data_type,
                        net_cfg_instance_id,
                        &len);

                if (status == ERROR_SUCCESS && data_type == REG_SZ)
                {
                    if (!strcmp(component_id, TAP_WIN_COMPONENT_ID))
                    {
                        /* That thing is a valid interface key */
                        /* link into return list */
                        char *guid = malloc(sizeof(net_cfg_instance_id));
                        memcpy(guid, net_cfg_instance_id, sizeof(net_cfg_instance_id));
                        list->insert_last(list, guid);
                    }
                }
            }
            RegCloseKey(unit_key);
        }
        ++i;
    }

    RegCloseKey(adapter_key);
    return list;
}
\end{lstlisting}
\end{center}
\subsection{Lizensierung der Arbeit}
Diese \ac{BA} steht unter der GNU General Public License version 3 (GPLv3)
und darf unter Berücksichtigung der Lizensvereinbarung der GPLv3 verfielfältigt
und verteilt werden. Der Lizenztext ist auf der offiziellen Webseite\footnote{\url{https://www.gnu.org/licenses/gpl.html}}
zu finden.

Das Logo der \ac{HSO} steht unter seiner eigenen Lizenz. Es steht nicht unter der GPLv3.
Der gesamte Code steht unter der URL \url{https://github.com/Thermi/Bachelorarbeit} zur Verfügung.

\begin{centering} 

Diese Arbeit wurde mittels \LaTeX erstellt
\end{centering}
